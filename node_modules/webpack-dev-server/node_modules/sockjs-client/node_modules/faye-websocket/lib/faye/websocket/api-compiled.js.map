{"version":3,"sources":["api.js"],"names":[],"mappings":"AAAA,IAAI,SAAc,QAAQ,QAAR,EAAkB,MAApC;IACI,OAAc,QAAQ,MAAR,CADlB;IAEI,SAAc,QAAQ,kBAAR,CAFlB;IAGI,cAAc,QAAQ,oBAAR,CAHlB;IAII,QAAc,QAAQ,aAAR,CAJlB;;AAMA,IAAI,MAAM,UAAS,OAAT,EAAkB;AAC1B,YAAU,WAAW,EAArB;AACA,SAAO,eAAP,CAAuB,OAAvB,EAAgC,CAAC,SAAD,EAAY,YAAZ,EAA0B,WAA1B,EAAuC,MAAvC,EAA+C,OAA/C,EAAwD,KAAxD,EAA+D,IAA/D,CAAhC;;AAEA,OAAK,QAAL,GAAgB,KAAK,QAAL,GAAgB,IAAhC;;AAEA,MAAI,UAAU,QAAQ,OAAtB;AACA,MAAI,OAAJ,EAAa;AACX,SAAK,IAAI,IAAT,IAAiB,OAAjB,EAA0B,KAAK,OAAL,CAAa,SAAb,CAAuB,IAAvB,EAA6B,QAAQ,IAAR,CAA7B;AAC3B;;AAED,MAAI,aAAa,QAAQ,UAAzB;AACA,MAAI,UAAJ,EAAgB;AACd,OAAG,MAAH,CAAU,UAAV,EAAsB,OAAtB,CAA8B,KAAK,OAAL,CAAa,YAA3C,EAAyD,KAAK,OAA9D;AACD;;AAED,OAAK,KAAL,GAAsB,QAAQ,IAA9B;AACA,OAAK,OAAL,GAAsB,CAAtB;AACA,OAAK,UAAL,GAAsB,IAAI,UAA1B;AACA,OAAK,cAAL,GAAsB,CAAtB;AACA,OAAK,QAAL,GAAsB,EAAtB;AACA,OAAK,GAAL,GAAsB,KAAK,OAAL,CAAa,GAAnC;AACA,OAAK,OAAL,GAAsB,KAAK,OAAL,CAAa,OAAnC;;AAEA,MAAI,OAAO,IAAX;;AAEA,OAAK,OAAL,CAAa,EAAb,CAAgB,MAAhB,EAA2B,UAAS,CAAT,EAAY;AAAE,SAAK,KAAL;AAAc,GAAvD;AACA,OAAK,OAAL,CAAa,EAAb,CAAgB,SAAhB,EAA2B,UAAS,CAAT,EAAY;AAAE,SAAK,eAAL,CAAqB,EAAE,IAAvB;AAA8B,GAAvE;AACA,OAAK,OAAL,CAAa,EAAb,CAAgB,OAAhB,EAA2B,UAAS,CAAT,EAAY;AAAE,SAAK,WAAL,CAAiB,EAAE,MAAnB,EAA2B,EAAE,IAA7B;AAAoC,GAA7E;;AAEA,OAAK,OAAL,CAAa,EAAb,CAAgB,OAAhB,EAAyB,UAAS,KAAT,EAAgB;AACvC,SAAK,UAAL,CAAgB,MAAM,OAAtB;AACD,GAFD;AAGA,OAAK,EAAL,CAAQ,OAAR,EAAiB,YAAW,CAAE,CAA9B;;AAEA,OAAK,OAAL,CAAa,QAAb,CAAsB,EAAtB,CAAyB,OAAzB,EAAkC,YAAW;AAC3C,SAAK,IAAL,CAAU,OAAV;AACD,GAFD;;AAIA,MAAI,KAAK,KAAT,EACE,KAAK,UAAL,GAAkB,YAAY,YAAW;AACvC,SAAK,OAAL,IAAgB,CAAhB;AACA,SAAK,IAAL,CAAU,KAAK,OAAL,CAAa,QAAb,EAAV;AACD,GAHiB,EAGf,KAAK,KAAL,GAAa,IAHE,CAAlB;;AAKF,OAAK,gBAAL;;AAEA,MAAI,CAAC,KAAK,MAAV,EAAkB;AAChB,SAAK,OAAL,CAAa,IAAb,CAAkB,KAAK,OAAL,CAAa,EAA/B;AACA,SAAK,OAAL,CAAa,EAAb,CAAgB,IAAhB,CAAqB,KAAK,OAA1B;AACD;AACF,CAnDD;AAoDA,KAAK,QAAL,CAAc,GAAd,EAAmB,MAAnB;;AAEA,IAAI,UAAJ,GAAiB,CAAjB;AACA,IAAI,IAAJ,GAAiB,CAAjB;AACA,IAAI,OAAJ,GAAiB,CAAjB;AACA,IAAI,MAAJ,GAAiB,CAAjB;;AAEA,IAAI,WAAW;AACb,SAAO,UAAS,IAAT,EAAe;AACpB,WAAO,KAAK,IAAL,CAAU,IAAV,CAAP;AACD,GAHY;;AAKb,OAAK,UAAS,IAAT,EAAe;AAClB,QAAI,SAAS,SAAb,EAAwB,KAAK,IAAL,CAAU,IAAV;AACxB,SAAK,KAAL;AACD,GARY;;AAUb,SAAO,YAAW;AAChB,WAAO,KAAK,OAAL,CAAa,QAAb,CAAsB,KAAtB,EAAP;AACD,GAZY;;AAcb,UAAQ,YAAW;AACjB,WAAO,KAAK,OAAL,CAAa,QAAb,CAAsB,MAAtB,EAAP;AACD,GAhBY;;AAkBb,QAAM,UAAS,IAAT,EAAe;AACnB,QAAI,KAAK,UAAL,GAAkB,IAAI,IAA1B,EAAgC,OAAO,KAAP;AAChC,QAAI,EAAE,gBAAgB,MAAlB,CAAJ,EAA+B,OAAO,OAAO,IAAP,CAAP;AAC/B,WAAO,KAAK,OAAL,CAAa,QAAb,CAAsB,KAAtB,CAA4B,IAA5B,CAAP;AACD,GAtBY;;AAwBb,QAAM,UAAS,OAAT,EAAkB,QAAlB,EAA4B;AAChC,QAAI,KAAK,UAAL,GAAkB,IAAI,IAA1B,EAAgC,OAAO,KAAP;AAChC,WAAO,KAAK,OAAL,CAAa,IAAb,CAAkB,OAAlB,EAA2B,QAA3B,CAAP;AACD,GA3BY;;AA6Bb,SAAO,UAAS,IAAT,EAAe,MAAf,EAAuB;AAC5B,QAAI,SAAS,SAAb,EAAwB,OAAO,IAAP;AACxB,QAAI,WAAW,SAAf,EAA0B,SAAS,EAAT;;AAE1B,QAAI,SAAS,IAAT,KAAkB,OAAO,IAAP,IAAe,OAAO,IAAxC,CAAJ,EACE,MAAM,IAAI,KAAJ,CAAU,6CACA,0DADA,GAEA,IAFA,GAEO,cAFjB,CAAN;;AAIF,QAAI,KAAK,UAAL,KAAoB,IAAI,MAA5B,EAAoC,KAAK,UAAL,GAAkB,IAAI,OAAtB;AACpC,SAAK,OAAL,CAAa,KAAb,CAAmB,MAAnB,EAA2B,IAA3B;AACD,GAxCY;;AA0Cb,oBAAkB,YAAW;AAC3B,QAAI,OAAO,IAAX;;AAEA,SAAK,OAAL,CAAa,UAAb,CAAwB,CAAxB;AACA,SAAK,OAAL,CAAa,UAAb,CAAwB,IAAxB;;AAEA,KAAC,OAAD,EAAU,KAAV,EAAiB,OAAjB,CAAyB,UAAS,KAAT,EAAgB;AACvC,WAAK,OAAL,CAAa,EAAb,CAAgB,KAAhB,EAAuB,YAAW;AAAE,aAAK,cAAL;AAAuB,OAA3D;AACD,KAFD,EAEG,IAFH;;AAIA,SAAK,OAAL,CAAa,EAAb,CAAgB,OAAhB,EAAyB,UAAS,KAAT,EAAgB;AACvC,WAAK,UAAL,CAAgB,oBAAoB,KAAK,GAAzB,GAA+B,IAA/B,GAAsC,MAAM,OAA5D;AACA,WAAK,cAAL;AACD,KAHD;AAID,GAxDY;;AA0Dd,SAAO,YAAW;AACf,QAAI,KAAK,UAAL,KAAoB,IAAI,UAA5B,EAAwC;;AAExC,SAAK,UAAL,GAAkB,IAAI,IAAtB;AACA,SAAK,QAAL,GAAgB,KAAK,OAAL,CAAa,QAAb,IAAyB,EAAzC;;AAEA,QAAI,QAAQ,IAAI,KAAJ,CAAU,MAAV,CAAZ;AACA,UAAM,SAAN,CAAgB,MAAhB,EAAwB,KAAxB,EAA+B,KAA/B;AACA,SAAK,aAAL,CAAmB,KAAnB;AACD,GAnEY;;AAqEb,mBAAiB,UAAS,IAAT,EAAe;AAC9B,QAAI,KAAK,UAAL,GAAkB,IAAI,IAA1B,EAAgC,OAAO,KAAP;;AAEhC,QAAI,KAAK,QAAT,EAAmB,KAAK,IAAL,CAAU,MAAV,EAAkB,IAAlB;;AAEnB,QAAI,QAAQ,IAAI,KAAJ,CAAU,SAAV,EAAqB,EAAC,MAAM,IAAP,EAArB,CAAZ;AACA,UAAM,SAAN,CAAgB,SAAhB,EAA2B,KAA3B,EAAkC,KAAlC;AACA,SAAK,aAAL,CAAmB,KAAnB;AACD,GA7EY;;AA+Eb,cAAY,UAAS,OAAT,EAAkB;AAC5B,QAAI,KAAK,UAAL,IAAmB,IAAI,OAA3B,EAAoC;;AAEpC,QAAI,QAAQ,IAAI,KAAJ,CAAU,OAAV,EAAmB,EAAC,SAAS,OAAV,EAAnB,CAAZ;AACA,UAAM,SAAN,CAAgB,OAAhB,EAAyB,KAAzB,EAAgC,KAAhC;AACA,SAAK,aAAL,CAAmB,KAAnB;AACD,GArFY;;AAuFb,eAAa,UAAS,MAAT,EAAiB,IAAjB,EAAuB;AAClC,QAAI,KAAK,UAAL,KAAoB,IAAI,MAA5B,EAAoC;AACpC,SAAK,UAAL,GAAkB,IAAI,OAAtB;AACA,SAAK,YAAL,GAAoB,CAAC,MAAD,EAAS,IAAT,CAApB;;AAEA,QAAI,KAAK,OAAT,EAAkB;AAChB,WAAK,OAAL,CAAa,GAAb;AACA,UAAI,CAAC,KAAK,OAAL,CAAa,QAAlB,EAA4B,KAAK,cAAL;AAC7B;AACF,GAhGY;;AAkGb,kBAAgB,YAAW;AACzB,QAAI,KAAK,UAAL,KAAoB,IAAI,MAA5B,EAAoC;AACpC,SAAK,UAAL,GAAkB,IAAI,MAAtB;;AAEA,QAAI,KAAK,UAAT,EAAqB,cAAc,KAAK,UAAnB;AACrB,QAAI,KAAK,OAAT,EAAkB,KAAK,OAAL,CAAa,GAAb;;AAElB,QAAI,KAAK,QAAT,EAAmB,KAAK,IAAL,CAAU,KAAV;AACnB,SAAK,QAAL,GAAgB,KAAK,QAAL,GAAgB,KAAhC;;AAEA,QAAI,SAAS,KAAK,YAAL,GAAoB,KAAK,YAAL,CAAkB,CAAlB,CAApB,GAA2C,EAAxD;QACI,OAAS,KAAK,YAAL,GAAoB,KAAK,YAAL,CAAkB,CAAlB,CAApB,GAA2C,IADxD;;AAGA,QAAI,QAAQ,IAAI,KAAJ,CAAU,OAAV,EAAmB,EAAC,MAAM,IAAP,EAAa,QAAQ,MAArB,EAAnB,CAAZ;AACA,UAAM,SAAN,CAAgB,OAAhB,EAAyB,KAAzB,EAAgC,KAAhC;AACA,SAAK,aAAL,CAAmB,KAAnB;AACD;AAlHY,CAAf;;AAqHA,KAAK,IAAI,MAAT,IAAmB,QAAnB,EAA6B,IAAI,SAAJ,CAAc,MAAd,IAAwB,SAAS,MAAT,CAAxB;AAC7B,KAAK,IAAI,GAAT,IAAgB,WAAhB,EAA6B,IAAI,SAAJ,CAAc,GAAd,IAAqB,YAAY,GAAZ,CAArB;;AAE7B,OAAO,OAAP,GAAiB,GAAjB","file":"api-compiled.js","sourcesContent":["var Stream      = require('stream').Stream,\n    util        = require('util'),\n    driver      = require('websocket-driver'),\n    EventTarget = require('./api/event_target'),\n    Event       = require('./api/event');\n\nvar API = function(options) {\n  options = options || {};\n  driver.validateOptions(options, ['headers', 'extensions', 'maxLength', 'ping', 'proxy', 'tls', 'ca']);\n\n  this.readable = this.writable = true;\n\n  var headers = options.headers;\n  if (headers) {\n    for (var name in headers) this._driver.setHeader(name, headers[name]);\n  }\n\n  var extensions = options.extensions;\n  if (extensions) {\n    [].concat(extensions).forEach(this._driver.addExtension, this._driver);\n  }\n\n  this._ping          = options.ping;\n  this._pingId        = 0;\n  this.readyState     = API.CONNECTING;\n  this.bufferedAmount = 0;\n  this.protocol       = '';\n  this.url            = this._driver.url;\n  this.version        = this._driver.version;\n\n  var self = this;\n\n  this._driver.on('open',    function(e) { self._open() });\n  this._driver.on('message', function(e) { self._receiveMessage(e.data) });\n  this._driver.on('close',   function(e) { self._beginClose(e.reason, e.code) });\n\n  this._driver.on('error', function(error) {\n    self._emitError(error.message);\n  });\n  this.on('error', function() {});\n\n  this._driver.messages.on('drain', function() {\n    self.emit('drain');\n  });\n\n  if (this._ping)\n    this._pingTimer = setInterval(function() {\n      self._pingId += 1;\n      self.ping(self._pingId.toString());\n    }, this._ping * 1000);\n\n  this._configureStream();\n\n  if (!this._proxy) {\n    this._stream.pipe(this._driver.io);\n    this._driver.io.pipe(this._stream);\n  }\n};\nutil.inherits(API, Stream);\n\nAPI.CONNECTING = 0;\nAPI.OPEN       = 1;\nAPI.CLOSING    = 2;\nAPI.CLOSED     = 3;\n\nvar instance = {\n  write: function(data) {\n    return this.send(data);\n  },\n\n  end: function(data) {\n    if (data !== undefined) this.send(data);\n    this.close();\n  },\n\n  pause: function() {\n    return this._driver.messages.pause();\n  },\n\n  resume: function() {\n    return this._driver.messages.resume();\n  },\n\n  send: function(data) {\n    if (this.readyState > API.OPEN) return false;\n    if (!(data instanceof Buffer)) data = String(data);\n    return this._driver.messages.write(data);\n  },\n\n  ping: function(message, callback) {\n    if (this.readyState > API.OPEN) return false;\n    return this._driver.ping(message, callback);\n  },\n\n  close: function(code, reason) {\n    if (code === undefined) code = 1000;\n    if (reason === undefined) reason = '';\n\n    if (code !== 1000 && (code < 3000 || code > 4999))\n      throw new Error(\"Failed to execute 'close' on WebSocket: \" +\n                      \"The code must be either 1000, or between 3000 and 4999. \" +\n                      code + \" is neither.\");\n\n    if (this.readyState !== API.CLOSED) this.readyState = API.CLOSING;\n    this._driver.close(reason, code);\n  },\n\n  _configureStream: function() {\n    var self = this;\n\n    this._stream.setTimeout(0);\n    this._stream.setNoDelay(true);\n\n    ['close', 'end'].forEach(function(event) {\n      this._stream.on(event, function() { self._finalizeClose() });\n    }, this);\n\n    this._stream.on('error', function(error) {\n      self._emitError('Network error: ' + self.url + ': ' + error.message);\n      self._finalizeClose();\n    });\n  },\n\n _open: function() {\n    if (this.readyState !== API.CONNECTING) return;\n\n    this.readyState = API.OPEN;\n    this.protocol = this._driver.protocol || '';\n\n    var event = new Event('open');\n    event.initEvent('open', false, false);\n    this.dispatchEvent(event);\n  },\n\n  _receiveMessage: function(data) {\n    if (this.readyState > API.OPEN) return false;\n\n    if (this.readable) this.emit('data', data);\n\n    var event = new Event('message', {data: data});\n    event.initEvent('message', false, false);\n    this.dispatchEvent(event);\n  },\n\n  _emitError: function(message) {\n    if (this.readyState >= API.CLOSING) return;\n\n    var event = new Event('error', {message: message});\n    event.initEvent('error', false, false);\n    this.dispatchEvent(event);\n  },\n\n  _beginClose: function(reason, code) {\n    if (this.readyState === API.CLOSED) return;\n    this.readyState = API.CLOSING;\n    this._closeParams = [reason, code];\n\n    if (this._stream) {\n      this._stream.end();\n      if (!this._stream.readable) this._finalizeClose();\n    }\n  },\n\n  _finalizeClose: function() {\n    if (this.readyState === API.CLOSED) return;\n    this.readyState = API.CLOSED;\n\n    if (this._pingTimer) clearInterval(this._pingTimer);\n    if (this._stream) this._stream.end();\n\n    if (this.readable) this.emit('end');\n    this.readable = this.writable = false;\n\n    var reason = this._closeParams ? this._closeParams[0] : '',\n        code   = this._closeParams ? this._closeParams[1] : 1006;\n\n    var event = new Event('close', {code: code, reason: reason});\n    event.initEvent('close', false, false);\n    this.dispatchEvent(event);\n  }\n};\n\nfor (var method in instance) API.prototype[method] = instance[method];\nfor (var key in EventTarget) API.prototype[key] = EventTarget[key];\n\nmodule.exports = API;\n"]}