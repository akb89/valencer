{"version":3,"sources":["client.js"],"names":[],"mappings":"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","file":"client-compiled.js","sourcesContent":["'use strict';\n\nvar crypto     = require('crypto'),\n    url        = require('url'),\n    util       = require('util'),\n    HttpParser = require('../http_parser'),\n    Base       = require('./base'),\n    Hybi       = require('./hybi'),\n    Proxy      = require('./proxy');\n\nvar Client = function(_url, options) {\n  this.version = 'hybi-13';\n  Hybi.call(this, null, _url, options);\n\n  this.readyState = -1;\n  this._key       = Client.generateKey();\n  this._accept    = Hybi.generateAccept(this._key);\n  this._http      = new HttpParser('response');\n\n  var uri  = url.parse(this.url),\n      auth = uri.auth && new Buffer(uri.auth, 'utf8').toString('base64');\n\n  if (this.VALID_PROTOCOLS.indexOf(uri.protocol) < 0)\n    throw new Error(this.url + ' is not a valid WebSocket URL');\n\n  this._pathname = (uri.pathname || '/') + (uri.search || '');\n\n  this._headers.set('Host', uri.host);\n  this._headers.set('Upgrade', 'websocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('Sec-WebSocket-Key', this._key);\n  this._headers.set('Sec-WebSocket-Version', '13');\n\n  if (this._protocols.length > 0)\n    this._headers.set('Sec-WebSocket-Protocol', this._protocols.join(', '));\n\n  if (auth)\n    this._headers.set('Authorization', 'Basic ' + auth);\n};\nutil.inherits(Client, Hybi);\n\nClient.generateKey = function() {\n  return crypto.randomBytes(16).toString('base64');\n};\n\nvar instance = {\n  VALID_PROTOCOLS: ['ws:', 'wss:'],\n\n  proxy: function(origin, options) {\n    return new Proxy(this, origin, options);\n  },\n\n  start: function() {\n    if (this.readyState !== -1) return false;\n    this._write(this._handshakeRequest());\n    this.readyState = 0;\n    return true;\n  },\n\n  parse: function(chunk) {\n    if (this.readyState === 3) return;\n    if (this.readyState > 0) return Hybi.prototype.parse.call(this, chunk);\n\n    this._http.parse(chunk);\n    if (!this._http.isComplete()) return;\n\n    this._validateHandshake();\n    if (this.readyState === 3) return;\n\n    this._open();\n    this.parse(this._http.body);\n  },\n\n  _handshakeRequest: function() {\n    var extensions = this._extensions.generateOffer();\n    if (extensions)\n      this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n    var start   = 'GET ' + this._pathname + ' HTTP/1.1',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _failHandshake: function(message) {\n    message = 'Error during WebSocket handshake: ' + message;\n    this.readyState = 3;\n    this.emit('error', new Error(message));\n    this.emit('close', new Base.CloseEvent(this.ERRORS.protocol_error, message));\n  },\n\n  _validateHandshake: function() {\n    this.statusCode = this._http.statusCode;\n    this.headers    = this._http.headers;\n\n    if (this._http.statusCode !== 101)\n      return this._failHandshake('Unexpected response code: ' + this._http.statusCode);\n\n    var headers    = this._http.headers,\n        upgrade    = headers['upgrade'] || '',\n        connection = headers['connection'] || '',\n        accept     = headers['sec-websocket-accept'] || '',\n        protocol   = headers['sec-websocket-protocol'] || '';\n\n    if (upgrade === '')\n      return this._failHandshake(\"'Upgrade' header is missing\");\n    if (upgrade.toLowerCase() !== 'websocket')\n      return this._failHandshake(\"'Upgrade' header value is not 'WebSocket'\");\n\n    if (connection === '')\n      return this._failHandshake(\"'Connection' header is missing\");\n    if (connection.toLowerCase() !== 'upgrade')\n      return this._failHandshake(\"'Connection' header value is not 'Upgrade'\");\n\n    if (accept !== this._accept)\n      return this._failHandshake('Sec-WebSocket-Accept mismatch');\n\n    this.protocol = null;\n\n    if (protocol !== '') {\n      if (this._protocols.indexOf(protocol) < 0)\n        return this._failHandshake('Sec-WebSocket-Protocol mismatch');\n      else\n        this.protocol = protocol;\n    }\n\n    try {\n      this._extensions.activate(this.headers['sec-websocket-extensions']);\n    } catch (e) {\n      return this._failHandshake(e.message);\n    }\n  }\n};\n\nfor (var key in instance)\n  Client.prototype[key] = instance[key];\n\nmodule.exports = Client;\n"]}