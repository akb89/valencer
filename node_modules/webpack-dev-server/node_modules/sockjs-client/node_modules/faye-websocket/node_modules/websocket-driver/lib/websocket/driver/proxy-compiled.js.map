{"version":3,"sources":["proxy.js"],"names":[],"mappings":"AAAA;;AAEA,IAAI,SAAa,QAAQ,QAAR,EAAkB,MAAnC;IACI,MAAa,QAAQ,KAAR,CADjB;IAEI,OAAa,QAAQ,MAAR,CAFjB;IAGI,OAAa,QAAQ,QAAR,CAHjB;IAII,UAAa,QAAQ,WAAR,CAJjB;IAKI,aAAa,QAAQ,gBAAR,CALjB;;AAOA,IAAI,QAAQ,EAAC,OAAO,EAAR,EAAY,QAAQ,GAApB,EAAZ;;AAEA,IAAI,QAAQ,UAAS,MAAT,EAAiB,MAAjB,EAAyB,OAAzB,EAAkC;AAC5C,OAAK,OAAL,GAAgB,MAAhB;AACA,OAAK,KAAL,GAAgB,IAAI,UAAJ,CAAe,UAAf,CAAhB;AACA,OAAK,OAAL,GAAiB,OAAO,OAAO,GAAd,KAAsB,QAAvB,GAAmC,OAAO,GAA1C,GAAgD,IAAI,KAAJ,CAAU,OAAO,GAAjB,CAAhE;AACA,OAAK,IAAL,GAAiB,OAAO,MAAP,KAAkB,QAAnB,GAA+B,MAA/B,GAAwC,IAAI,KAAJ,CAAU,MAAV,CAAxD;AACA,OAAK,QAAL,GAAgB,WAAW,EAA3B;AACA,OAAK,MAAL,GAAgB,CAAhB;;AAEA,OAAK,QAAL,GAAgB,KAAK,QAAL,GAAgB,IAAhC;AACA,OAAK,OAAL,GAAgB,KAAhB;;AAEA,OAAK,QAAL,GAAgB,IAAI,OAAJ,EAAhB;AACA,OAAK,QAAL,CAAc,GAAd,CAAkB,MAAlB,EAA0B,KAAK,OAAL,CAAa,IAAvC;AACA,OAAK,QAAL,CAAc,GAAd,CAAkB,YAAlB,EAAgC,YAAhC;AACA,OAAK,QAAL,CAAc,GAAd,CAAkB,kBAAlB,EAAsC,YAAtC;;AAEA,MAAI,OAAO,KAAK,IAAL,CAAU,IAAV,IAAkB,IAAI,MAAJ,CAAW,KAAK,IAAL,CAAU,IAArB,EAA2B,MAA3B,EAAmC,QAAnC,CAA4C,QAA5C,CAA7B;AACA,MAAI,IAAJ,EAAU,KAAK,QAAL,CAAc,GAAd,CAAkB,qBAAlB,EAAyC,WAAW,IAApD;AACX,CAlBD;AAmBA,KAAK,QAAL,CAAc,KAAd,EAAqB,MAArB;;AAEA,IAAI,WAAW;AACb,aAAW,UAAS,IAAT,EAAe,KAAf,EAAsB;AAC/B,QAAI,KAAK,MAAL,KAAgB,CAApB,EAAuB,OAAO,KAAP;AACvB,SAAK,QAAL,CAAc,GAAd,CAAkB,IAAlB,EAAwB,KAAxB;AACA,WAAO,IAAP;AACD,GALY;;AAOb,SAAO,YAAW;AAChB,QAAI,KAAK,MAAL,KAAgB,CAApB,EAAuB,OAAO,KAAP;AACvB,SAAK,MAAL,GAAc,CAAd;;AAEA,QAAI,SAAS,KAAK,OAAlB;QACI,OAAS,OAAO,IAAP,IAAe,MAAM,OAAO,QAAb,CAD5B;QAEI,QAAS,aAAa,OAAO,QAApB,GAA+B,GAA/B,GAAqC,IAArC,GAA4C,WAFzD;;AAIA,QAAI,UAAU,CAAC,KAAD,EAAQ,KAAK,QAAL,CAAc,QAAd,EAAR,EAAkC,EAAlC,CAAd;;AAEA,SAAK,IAAL,CAAU,MAAV,EAAkB,IAAI,MAAJ,CAAW,QAAQ,IAAR,CAAa,MAAb,CAAX,EAAiC,MAAjC,CAAlB;AACA,WAAO,IAAP;AACD,GAnBY;;AAqBb,SAAO,YAAW;AAChB,SAAK,OAAL,GAAe,IAAf;AACD,GAvBY;;AAyBb,UAAQ,YAAW;AACjB,SAAK,OAAL,GAAe,KAAf;AACA,SAAK,IAAL,CAAU,OAAV;AACD,GA5BY;;AA8Bb,SAAO,UAAS,KAAT,EAAgB;AACrB,QAAI,CAAC,KAAK,QAAV,EAAoB,OAAO,KAAP;;AAEpB,SAAK,KAAL,CAAW,KAAX,CAAiB,KAAjB;AACA,QAAI,CAAC,KAAK,KAAL,CAAW,UAAX,EAAL,EAA8B,OAAO,CAAC,KAAK,OAAb;;AAE9B,SAAK,UAAL,GAAkB,KAAK,KAAL,CAAW,UAA7B;AACA,SAAK,OAAL,GAAkB,KAAK,KAAL,CAAW,OAA7B;;AAEA,QAAI,KAAK,UAAL,KAAoB,GAAxB,EAA6B;AAC3B,WAAK,IAAL,CAAU,SAAV,EAAqB,IAAI,KAAK,YAAT,EAArB;AACD,KAFD,MAEO;AACL,UAAI,UAAU,mDAAmD,KAAK,OAAL,CAAa,IAA9E;AACA,WAAK,IAAL,CAAU,OAAV,EAAmB,IAAI,KAAJ,CAAU,OAAV,CAAnB;AACD;AACD,SAAK,GAAL;AACA,WAAO,CAAC,KAAK,OAAb;AACD,GA/CY;;AAiDb,OAAK,UAAS,KAAT,EAAgB;AACnB,QAAI,CAAC,KAAK,QAAV,EAAoB;AACpB,QAAI,UAAU,SAAd,EAAyB,KAAK,KAAL,CAAW,KAAX;AACzB,SAAK,QAAL,GAAgB,KAAK,QAAL,GAAgB,KAAhC;AACA,SAAK,IAAL,CAAU,OAAV;AACA,SAAK,IAAL,CAAU,KAAV;AACD,GAvDY;;AAyDb,WAAS,YAAW;AAClB,SAAK,GAAL;AACD;AA3DY,CAAf;;AA8DA,KAAK,IAAI,GAAT,IAAgB,QAAhB,EACE,MAAM,SAAN,CAAgB,GAAhB,IAAuB,SAAS,GAAT,CAAvB;;AAEF,OAAO,OAAP,GAAiB,KAAjB","file":"proxy-compiled.js","sourcesContent":["'use strict';\n\nvar Stream     = require('stream').Stream,\n    url        = require('url'),\n    util       = require('util'),\n    Base       = require('./base'),\n    Headers    = require('./headers'),\n    HttpParser = require('../http_parser');\n\nvar PORTS = {'ws:': 80, 'wss:': 443};\n\nvar Proxy = function(client, origin, options) {\n  this._client  = client;\n  this._http    = new HttpParser('response');\n  this._origin  = (typeof client.url === 'object') ? client.url : url.parse(client.url);\n  this._url     = (typeof origin === 'object') ? origin : url.parse(origin);\n  this._options = options || {};\n  this._state   = 0;\n\n  this.readable = this.writable = true;\n  this._paused  = false;\n\n  this._headers = new Headers();\n  this._headers.set('Host', this._origin.host);\n  this._headers.set('Connection', 'keep-alive');\n  this._headers.set('Proxy-Connection', 'keep-alive');\n\n  var auth = this._url.auth && new Buffer(this._url.auth, 'utf8').toString('base64');\n  if (auth) this._headers.set('Proxy-Authorization', 'Basic ' + auth);\n};\nutil.inherits(Proxy, Stream);\n\nvar instance = {\n  setHeader: function(name, value) {\n    if (this._state !== 0) return false;\n    this._headers.set(name, value);\n    return true;\n  },\n\n  start: function() {\n    if (this._state !== 0) return false;\n    this._state = 1;\n\n    var origin = this._origin,\n        port   = origin.port || PORTS[origin.protocol],\n        start  = 'CONNECT ' + origin.hostname + ':' + port + ' HTTP/1.1';\n\n    var headers = [start, this._headers.toString(), ''];\n\n    this.emit('data', new Buffer(headers.join('\\r\\n'), 'utf8'));\n    return true;\n  },\n\n  pause: function() {\n    this._paused = true;\n  },\n\n  resume: function() {\n    this._paused = false;\n    this.emit('drain');\n  },\n\n  write: function(chunk) {\n    if (!this.writable) return false;\n\n    this._http.parse(chunk);\n    if (!this._http.isComplete()) return !this._paused;\n\n    this.statusCode = this._http.statusCode;\n    this.headers    = this._http.headers;\n\n    if (this.statusCode === 200) {\n      this.emit('connect', new Base.ConnectEvent());\n    } else {\n      var message = \"Can't establish a connection to the server at \" + this._origin.href;\n      this.emit('error', new Error(message));\n    }\n    this.end();\n    return !this._paused;\n  },\n\n  end: function(chunk) {\n    if (!this.writable) return;\n    if (chunk !== undefined) this.write(chunk);\n    this.readable = this.writable = false;\n    this.emit('close');\n    this.emit('end');\n  },\n\n  destroy: function() {\n    this.end();\n  }\n};\n\nfor (var key in instance)\n  Proxy.prototype[key] = instance[key];\n\nmodule.exports = Proxy;\n"]}