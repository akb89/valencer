{"version":3,"sources":["draft76.js"],"names":[],"mappings":"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","file":"draft76-compiled.js","sourcesContent":["'use strict';\n\nvar Base    = require('./base'),\n    Draft75 = require('./draft75'),\n    crypto  = require('crypto'),\n    util    = require('util');\n\n\nvar numberFromKey = function(key) {\n  return parseInt(key.match(/[0-9]/g).join(''), 10);\n};\n\nvar spacesInKey = function(key) {\n  return key.match(/ /g).length;\n};\n\n\nvar Draft76 = function(request, url, options) {\n  Draft75.apply(this, arguments);\n  this._stage  = -1;\n  this._body   = [];\n  this.version = 'hixie-76';\n\n  this._headers.clear();\n\n  this._headers.set('Upgrade', 'WebSocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('Sec-WebSocket-Origin', this._request.headers.origin);\n  this._headers.set('Sec-WebSocket-Location', this.url);\n};\nutil.inherits(Draft76, Draft75);\n\nvar instance = {\n  BODY_SIZE: 8,\n\n  start: function() {\n    if (!Draft75.prototype.start.call(this)) return false;\n    this._started = true;\n    this._sendHandshakeBody();\n    return true;\n  },\n\n  close: function() {\n    if (this.readyState === 3) return false;\n    this._write(new Buffer([0xFF, 0x00]));\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n\n  _handshakeResponse: function() {\n    var headers = this._request.headers,\n\n        key1    = headers['sec-websocket-key1'],\n        number1 = numberFromKey(key1),\n        spaces1 = spacesInKey(key1),\n\n        key2    = headers['sec-websocket-key2'],\n        number2 = numberFromKey(key2),\n        spaces2 = spacesInKey(key2);\n\n    if (number1 % spaces1 !== 0 || number2 % spaces2 !== 0) {\n      this.emit('error', new Error('Client sent invalid Sec-WebSocket-Key headers'));\n      this.close();\n      return null;\n    }\n\n    this._keyValues = [number1 / spaces1, number2 / spaces2];\n\n    var start   = 'HTTP/1.1 101 WebSocket Protocol Handshake',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'binary');\n  },\n\n  _handshakeSignature: function() {\n    if (this._body.length < this.BODY_SIZE) return null;\n\n    var md5    = crypto.createHash('md5'),\n        buffer = new Buffer(8 + this.BODY_SIZE);\n\n    buffer.writeUInt32BE(this._keyValues[0], 0);\n    buffer.writeUInt32BE(this._keyValues[1], 4);\n    new Buffer(this._body).copy(buffer, 8, 0, this.BODY_SIZE);\n\n    md5.update(buffer);\n    return new Buffer(md5.digest('binary'), 'binary');\n  },\n\n  _sendHandshakeBody: function() {\n    if (!this._started) return;\n    var signature = this._handshakeSignature();\n    if (!signature) return;\n\n    this._write(signature);\n    this._stage = 0;\n    this._open();\n\n    if (this._body.length > this.BODY_SIZE)\n      this.parse(this._body.slice(this.BODY_SIZE));\n  },\n\n  _parseLeadingByte: function(octet) {\n    if (octet !== 0xFF)\n      return Draft75.prototype._parseLeadingByte.call(this, octet);\n\n    this._closing = true;\n    this._length  = 0;\n    this._stage   = 1;\n  }\n};\n\nfor (var key in instance)\n  Draft76.prototype[key] = instance[key];\n\nmodule.exports = Draft76;\n"]}