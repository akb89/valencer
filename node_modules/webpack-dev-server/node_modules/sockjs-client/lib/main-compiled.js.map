{"version":3,"sources":["main.js"],"names":[],"mappings":"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","file":"main-compiled.js","sourcesContent":["'use strict';\n\nrequire('./shims');\n\nvar URL = require('url-parse')\n  , inherits = require('inherits')\n  , JSON3 = require('json3')\n  , random = require('./utils/random')\n  , escape = require('./utils/escape')\n  , urlUtils = require('./utils/url')\n  , eventUtils = require('./utils/event')\n  , transport = require('./utils/transport')\n  , objectUtils = require('./utils/object')\n  , browser = require('./utils/browser')\n  , log = require('./utils/log')\n  , Event = require('./event/event')\n  , EventTarget = require('./event/eventtarget')\n  , loc = require('./location')\n  , CloseEvent = require('./event/close')\n  , TransportMessageEvent = require('./event/trans-message')\n  , InfoReceiver = require('./info-receiver')\n  ;\n\nvar debug = function() {};\nif (process.env.NODE_ENV !== 'production') {\n  debug = require('debug')('sockjs-client:main');\n}\n\nvar transports;\n\n// follow constructor steps defined at http://dev.w3.org/html5/websockets/#the-websocket-interface\nfunction SockJS(url, protocols, options) {\n  if (!(this instanceof SockJS)) {\n    return new SockJS(url, protocols, options);\n  }\n  if (arguments.length < 1) {\n    throw new TypeError(\"Failed to construct 'SockJS: 1 argument required, but only 0 present\");\n  }\n  EventTarget.call(this);\n\n  this.readyState = SockJS.CONNECTING;\n  this.extensions = '';\n  this.protocol = '';\n\n  // non-standard extension\n  options = options || {};\n  if (options.protocols_whitelist) {\n    log.warn(\"'protocols_whitelist' is DEPRECATED. Use 'transports' instead.\");\n  }\n  this._transportsWhitelist = options.transports;\n  this._transportOptions = options.transportOptions || {};\n\n  var sessionId = options.sessionId || 8;\n  if (typeof sessionId === 'function') {\n    this._generateSessionId = sessionId;\n  } else if (typeof sessionId === 'number') {\n    this._generateSessionId = function() {\n      return random.string(sessionId);\n    };\n  } else {\n    throw new TypeError('If sessionId is used in the options, it needs to be a number or a function.');\n  }\n\n  this._server = options.server || random.numberString(1000);\n\n  // Step 1 of WS spec - parse and validate the url. Issue #8\n  var parsedUrl = new URL(url);\n  if (!parsedUrl.host || !parsedUrl.protocol) {\n    throw new SyntaxError(\"The URL '\" + url + \"' is invalid\");\n  } else if (parsedUrl.hash) {\n    throw new SyntaxError('The URL must not contain a fragment');\n  } else if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {\n    throw new SyntaxError(\"The URL's scheme must be either 'http:' or 'https:'. '\" + parsedUrl.protocol + \"' is not allowed.\");\n  }\n\n  var secure = parsedUrl.protocol === 'https:';\n  // Step 2 - don't allow secure origin with an insecure protocol\n  if (loc.protocol === 'https' && !secure) {\n    throw new Error('SecurityError: An insecure SockJS connection may not be initiated from a page loaded over HTTPS');\n  }\n\n  // Step 3 - check port access - no need here\n  // Step 4 - parse protocols argument\n  if (!protocols) {\n    protocols = [];\n  } else if (!Array.isArray(protocols)) {\n    protocols = [protocols];\n  }\n\n  // Step 5 - check protocols argument\n  var sortedProtocols = protocols.sort();\n  sortedProtocols.forEach(function(proto, i) {\n    if (!proto) {\n      throw new SyntaxError(\"The protocols entry '\" + proto + \"' is invalid.\");\n    }\n    if (i < (sortedProtocols.length - 1) && proto === sortedProtocols[i + 1]) {\n      throw new SyntaxError(\"The protocols entry '\" + proto + \"' is duplicated.\");\n    }\n  });\n\n  // Step 6 - convert origin\n  var o = urlUtils.getOrigin(loc.href);\n  this._origin = o ? o.toLowerCase() : null;\n\n  // remove the trailing slash\n  parsedUrl.set('pathname', parsedUrl.pathname.replace(/\\/+$/, ''));\n\n  // store the sanitized url\n  this.url = parsedUrl.href;\n  debug('using url', this.url);\n\n  // Step 7 - start connection in background\n  // obtain server info\n  // http://sockjs.github.io/sockjs-protocol/sockjs-protocol-0.3.3.html#section-26\n  this._urlInfo = {\n    nullOrigin: !browser.hasDomain()\n  , sameOrigin: urlUtils.isOriginEqual(this.url, loc.href)\n  , sameScheme: urlUtils.isSchemeEqual(this.url, loc.href)\n  };\n\n  this._ir = new InfoReceiver(this.url, this._urlInfo);\n  this._ir.once('finish', this._receiveInfo.bind(this));\n}\n\ninherits(SockJS, EventTarget);\n\nfunction userSetCode(code) {\n  return code === 1000 || (code >= 3000 && code <= 4999);\n}\n\nSockJS.prototype.close = function(code, reason) {\n  // Step 1\n  if (code && !userSetCode(code)) {\n    throw new Error('InvalidAccessError: Invalid code');\n  }\n  // Step 2.4 states the max is 123 bytes, but we are just checking length\n  if (reason && reason.length > 123) {\n    throw new SyntaxError('reason argument has an invalid length');\n  }\n\n  // Step 3.1\n  if (this.readyState === SockJS.CLOSING || this.readyState === SockJS.CLOSED) {\n    return;\n  }\n\n  // TODO look at docs to determine how to set this\n  var wasClean = true;\n  this._close(code || 1000, reason || 'Normal closure', wasClean);\n};\n\nSockJS.prototype.send = function(data) {\n  // #13 - convert anything non-string to string\n  // TODO this currently turns objects into [object Object]\n  if (typeof data !== 'string') {\n    data = '' + data;\n  }\n  if (this.readyState === SockJS.CONNECTING) {\n    throw new Error('InvalidStateError: The connection has not been established yet');\n  }\n  if (this.readyState !== SockJS.OPEN) {\n    return;\n  }\n  this._transport.send(escape.quote(data));\n};\n\nSockJS.version = require('./version');\n\nSockJS.CONNECTING = 0;\nSockJS.OPEN = 1;\nSockJS.CLOSING = 2;\nSockJS.CLOSED = 3;\n\nSockJS.prototype._receiveInfo = function(info, rtt) {\n  debug('_receiveInfo', rtt);\n  this._ir = null;\n  if (!info) {\n    this._close(1002, 'Cannot connect to server');\n    return;\n  }\n\n  // establish a round-trip timeout (RTO) based on the\n  // round-trip time (RTT)\n  this._rto = this.countRTO(rtt);\n  // allow server to override url used for the actual transport\n  this._transUrl = info.base_url ? info.base_url : this.url;\n  info = objectUtils.extend(info, this._urlInfo);\n  debug('info', info);\n  // determine list of desired and supported transports\n  var enabledTransports = transports.filterToEnabled(this._transportsWhitelist, info);\n  this._transports = enabledTransports.main;\n  debug(this._transports.length + ' enabled transports');\n\n  this._connect();\n};\n\nSockJS.prototype._connect = function() {\n  for (var Transport = this._transports.shift(); Transport; Transport = this._transports.shift()) {\n    debug('attempt', Transport.transportName);\n    if (Transport.needBody) {\n      if (!global.document.body ||\n          (typeof global.document.readyState !== 'undefined' &&\n            global.document.readyState !== 'complete' &&\n            global.document.readyState !== 'interactive')) {\n        debug('waiting for body');\n        this._transports.unshift(Transport);\n        eventUtils.attachEvent('load', this._connect.bind(this));\n        return;\n      }\n    }\n\n    // calculate timeout based on RTO and round trips. Default to 5s\n    var timeoutMs = (this._rto * Transport.roundTrips) || 5000;\n    this._transportTimeoutId = setTimeout(this._transportTimeout.bind(this), timeoutMs);\n    debug('using timeout', timeoutMs);\n\n    var transportUrl = urlUtils.addPath(this._transUrl, '/' + this._server + '/' + this._generateSessionId());\n    var options = this._transportOptions[Transport.transportName];\n    debug('transport url', transportUrl);\n    var transportObj = new Transport(transportUrl, this._transUrl, options);\n    transportObj.on('message', this._transportMessage.bind(this));\n    transportObj.once('close', this._transportClose.bind(this));\n    transportObj.transportName = Transport.transportName;\n    this._transport = transportObj;\n\n    return;\n  }\n  this._close(2000, 'All transports failed', false);\n};\n\nSockJS.prototype._transportTimeout = function() {\n  debug('_transportTimeout');\n  if (this.readyState === SockJS.CONNECTING) {\n    this._transportClose(2007, 'Transport timed out');\n  }\n};\n\nSockJS.prototype._transportMessage = function(msg) {\n  debug('_transportMessage', msg);\n  var self = this\n    , type = msg.slice(0, 1)\n    , content = msg.slice(1)\n    , payload\n    ;\n\n  // first check for messages that don't need a payload\n  switch (type) {\n    case 'o':\n      this._open();\n      return;\n    case 'h':\n      this.dispatchEvent(new Event('heartbeat'));\n      debug('heartbeat', this.transport);\n      return;\n  }\n\n  if (content) {\n    try {\n      payload = JSON3.parse(content);\n    } catch (e) {\n      debug('bad json', content);\n    }\n  }\n\n  if (typeof payload === 'undefined') {\n    debug('empty payload', content);\n    return;\n  }\n\n  switch (type) {\n    case 'a':\n      if (Array.isArray(payload)) {\n        payload.forEach(function(p) {\n          debug('message', self.transport, p);\n          self.dispatchEvent(new TransportMessageEvent(p));\n        });\n      }\n      break;\n    case 'm':\n      debug('message', this.transport, payload);\n      this.dispatchEvent(new TransportMessageEvent(payload));\n      break;\n    case 'c':\n      if (Array.isArray(payload) && payload.length === 2) {\n        this._close(payload[0], payload[1], true);\n      }\n      break;\n  }\n};\n\nSockJS.prototype._transportClose = function(code, reason) {\n  debug('_transportClose', this.transport, code, reason);\n  if (this._transport) {\n    this._transport.removeAllListeners();\n    this._transport = null;\n    this.transport = null;\n  }\n\n  if (!userSetCode(code) && code !== 2000 && this.readyState === SockJS.CONNECTING) {\n    this._connect();\n    return;\n  }\n\n  this._close(code, reason);\n};\n\nSockJS.prototype._open = function() {\n  debug('_open', this._transport.transportName, this.readyState);\n  if (this.readyState === SockJS.CONNECTING) {\n    if (this._transportTimeoutId) {\n      clearTimeout(this._transportTimeoutId);\n      this._transportTimeoutId = null;\n    }\n    this.readyState = SockJS.OPEN;\n    this.transport = this._transport.transportName;\n    this.dispatchEvent(new Event('open'));\n    debug('connected', this.transport);\n  } else {\n    // The server might have been restarted, and lost track of our\n    // connection.\n    this._close(1006, 'Server lost session');\n  }\n};\n\nSockJS.prototype._close = function(code, reason, wasClean) {\n  debug('_close', this.transport, code, reason, wasClean, this.readyState);\n  var forceFail = false;\n\n  if (this._ir) {\n    forceFail = true;\n    this._ir.close();\n    this._ir = null;\n  }\n  if (this._transport) {\n    this._transport.close();\n    this._transport = null;\n    this.transport = null;\n  }\n\n  if (this.readyState === SockJS.CLOSED) {\n    throw new Error('InvalidStateError: SockJS has already been closed');\n  }\n\n  this.readyState = SockJS.CLOSING;\n  setTimeout(function() {\n    this.readyState = SockJS.CLOSED;\n\n    if (forceFail) {\n      this.dispatchEvent(new Event('error'));\n    }\n\n    var e = new CloseEvent('close');\n    e.wasClean = wasClean || false;\n    e.code = code || 1000;\n    e.reason = reason;\n\n    this.dispatchEvent(e);\n    this.onmessage = this.onclose = this.onerror = null;\n    debug('disconnected');\n  }.bind(this), 0);\n};\n\n// See: http://www.erg.abdn.ac.uk/~gerrit/dccp/notes/ccid2/rto_estimator/\n// and RFC 2988.\nSockJS.prototype.countRTO = function(rtt) {\n  // In a local environment, when using IE8/9 and the `jsonp-polling`\n  // transport the time needed to establish a connection (the time that pass\n  // from the opening of the transport to the call of `_dispatchOpen`) is\n  // around 200msec (the lower bound used in the article above) and this\n  // causes spurious timeouts. For this reason we calculate a value slightly\n  // larger than that used in the article.\n  if (rtt > 100) {\n    return 4 * rtt; // rto > 400msec\n  }\n  return 300 + rtt; // 300msec < rto <= 400msec\n};\n\nmodule.exports = function(availableTransports) {\n  transports = transport(availableTransports);\n  require('./iframe-bootstrap')(SockJS, availableTransports);\n  return SockJS;\n};\n"]}