{"version":3,"sources":["abstract-xhr.js"],"names":[],"mappings":"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","file":"abstract-xhr-compiled.js","sourcesContent":["'use strict';\n\nvar EventEmitter = require('events').EventEmitter\n  , inherits = require('inherits')\n  , utils = require('../../utils/event')\n  , urlUtils = require('../../utils/url')\n  , XHR = global.XMLHttpRequest\n  ;\n\nvar debug = function() {};\nif (process.env.NODE_ENV !== 'production') {\n  debug = require('debug')('sockjs-client:browser:xhr');\n}\n\nfunction AbstractXHRObject(method, url, payload, opts) {\n  debug(method, url);\n  var self = this;\n  EventEmitter.call(this);\n\n  setTimeout(function () {\n    self._start(method, url, payload, opts);\n  }, 0);\n}\n\ninherits(AbstractXHRObject, EventEmitter);\n\nAbstractXHRObject.prototype._start = function(method, url, payload, opts) {\n  var self = this;\n\n  try {\n    this.xhr = new XHR();\n  } catch (x) {\n    // intentionally empty\n  }\n\n  if (!this.xhr) {\n    debug('no xhr');\n    this.emit('finish', 0, 'no xhr support');\n    this._cleanup();\n    return;\n  }\n\n  // several browsers cache POSTs\n  url = urlUtils.addQuery(url, 't=' + (+new Date()));\n\n  // Explorer tends to keep connection open, even after the\n  // tab gets closed: http://bugs.jquery.com/ticket/5280\n  this.unloadRef = utils.unloadAdd(function() {\n    debug('unload cleanup');\n    self._cleanup(true);\n  });\n  try {\n    this.xhr.open(method, url, true);\n    if (this.timeout && 'timeout' in this.xhr) {\n      this.xhr.timeout = this.timeout;\n      this.xhr.ontimeout = function() {\n        debug('xhr timeout');\n        self.emit('finish', 0, '');\n        self._cleanup(false);\n      };\n    }\n  } catch (e) {\n    debug('exception', e);\n    // IE raises an exception on wrong port.\n    this.emit('finish', 0, '');\n    this._cleanup(false);\n    return;\n  }\n\n  if ((!opts || !opts.noCredentials) && AbstractXHRObject.supportsCORS) {\n    debug('withCredentials');\n    // Mozilla docs says https://developer.mozilla.org/en/XMLHttpRequest :\n    // \"This never affects same-site requests.\"\n\n    this.xhr.withCredentials = 'true';\n  }\n  if (opts && opts.headers) {\n    for (var key in opts.headers) {\n      this.xhr.setRequestHeader(key, opts.headers[key]);\n    }\n  }\n\n  this.xhr.onreadystatechange = function() {\n    if (self.xhr) {\n      var x = self.xhr;\n      var text, status;\n      debug('readyState', x.readyState);\n      switch (x.readyState) {\n      case 3:\n        // IE doesn't like peeking into responseText or status\n        // on Microsoft.XMLHTTP and readystate=3\n        try {\n          status = x.status;\n          text = x.responseText;\n        } catch (e) {\n          // intentionally empty\n        }\n        debug('status', status);\n        // IE returns 1223 for 204: http://bugs.jquery.com/ticket/1450\n        if (status === 1223) {\n          status = 204;\n        }\n\n        // IE does return readystate == 3 for 404 answers.\n        if (status === 200 && text && text.length > 0) {\n          debug('chunk');\n          self.emit('chunk', status, text);\n        }\n        break;\n      case 4:\n        status = x.status;\n        debug('status', status);\n        // IE returns 1223 for 204: http://bugs.jquery.com/ticket/1450\n        if (status === 1223) {\n          status = 204;\n        }\n        // IE returns this for a bad port\n        // http://msdn.microsoft.com/en-us/library/windows/desktop/aa383770(v=vs.85).aspx\n        if (status === 12005 || status === 12029) {\n          status = 0;\n        }\n\n        debug('finish', status, x.responseText);\n        self.emit('finish', status, x.responseText);\n        self._cleanup(false);\n        break;\n      }\n    }\n  };\n\n  try {\n    self.xhr.send(payload);\n  } catch (e) {\n    self.emit('finish', 0, '');\n    self._cleanup(false);\n  }\n};\n\nAbstractXHRObject.prototype._cleanup = function(abort) {\n  debug('cleanup');\n  if (!this.xhr) {\n    return;\n  }\n  this.removeAllListeners();\n  utils.unloadDel(this.unloadRef);\n\n  // IE needs this field to be a function\n  this.xhr.onreadystatechange = function() {};\n  if (this.xhr.ontimeout) {\n    this.xhr.ontimeout = null;\n  }\n\n  if (abort) {\n    try {\n      this.xhr.abort();\n    } catch (x) {\n      // intentionally empty\n    }\n  }\n  this.unloadRef = this.xhr = null;\n};\n\nAbstractXHRObject.prototype.close = function() {\n  debug('close');\n  this._cleanup(true);\n};\n\nAbstractXHRObject.enabled = !!XHR;\n// override XMLHttpRequest for IE6/7\n// obfuscate to avoid firewalls\nvar axo = ['Active'].concat('Object').join('X');\nif (!AbstractXHRObject.enabled && (axo in global)) {\n  debug('overriding xmlhttprequest');\n  XHR = function() {\n    try {\n      return new global[axo]('Microsoft.XMLHTTP');\n    } catch (e) {\n      return null;\n    }\n  };\n  AbstractXHRObject.enabled = !!new XHR();\n}\n\nvar cors = false;\ntry {\n  cors = 'withCredentials' in new XHR();\n} catch (ignored) {\n  // intentionally empty\n}\n\nAbstractXHRObject.supportsCORS = cors;\n\nmodule.exports = AbstractXHRObject;\n"]}