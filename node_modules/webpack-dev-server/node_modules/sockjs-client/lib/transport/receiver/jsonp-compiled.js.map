{"version":3,"sources":["jsonp.js"],"names":[],"mappings":"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","file":"jsonp-compiled.js","sourcesContent":["'use strict';\n\nvar utils = require('../../utils/iframe')\n  , random = require('../../utils/random')\n  , browser = require('../../utils/browser')\n  , urlUtils = require('../../utils/url')\n  , inherits = require('inherits')\n  , EventEmitter = require('events').EventEmitter\n  ;\n\nvar debug = function() {};\nif (process.env.NODE_ENV !== 'production') {\n  debug = require('debug')('sockjs-client:receiver:jsonp');\n}\n\nfunction JsonpReceiver(url) {\n  debug(url);\n  var self = this;\n  EventEmitter.call(this);\n\n  utils.polluteGlobalNamespace();\n\n  this.id = 'a' + random.string(6);\n  var urlWithId = urlUtils.addQuery(url, 'c=' + encodeURIComponent(utils.WPrefix + '.' + this.id));\n\n  global[utils.WPrefix][this.id] = this._callback.bind(this);\n  this._createScript(urlWithId);\n\n  // Fallback mostly for Konqueror - stupid timer, 35 seconds shall be plenty.\n  this.timeoutId = setTimeout(function() {\n    debug('timeout');\n    self._abort(new Error('JSONP script loaded abnormally (timeout)'));\n  }, JsonpReceiver.timeout);\n}\n\ninherits(JsonpReceiver, EventEmitter);\n\nJsonpReceiver.prototype.abort = function() {\n  debug('abort');\n  if (global[utils.WPrefix][this.id]) {\n    var err = new Error('JSONP user aborted read');\n    err.code = 1000;\n    this._abort(err);\n  }\n};\n\nJsonpReceiver.timeout = 35000;\nJsonpReceiver.scriptErrorTimeout = 1000;\n\nJsonpReceiver.prototype._callback = function(data) {\n  debug('_callback', data);\n  this._cleanup();\n\n  if (this.aborting) {\n    return;\n  }\n\n  if (data) {\n    debug('message', data);\n    this.emit('message', data);\n  }\n  this.emit('close', null, 'network');\n  this.removeAllListeners();\n};\n\nJsonpReceiver.prototype._abort = function(err) {\n  debug('_abort', err);\n  this._cleanup();\n  this.aborting = true;\n  this.emit('close', err.code, err.message);\n  this.removeAllListeners();\n};\n\nJsonpReceiver.prototype._cleanup = function() {\n  debug('_cleanup');\n  clearTimeout(this.timeoutId);\n  if (this.script2) {\n    this.script2.parentNode.removeChild(this.script2);\n    this.script2 = null;\n  }\n  if (this.script) {\n    var script = this.script;\n    // Unfortunately, you can't really abort script loading of\n    // the script.\n    script.parentNode.removeChild(script);\n    script.onreadystatechange = script.onerror =\n        script.onload = script.onclick = null;\n    this.script = null;\n  }\n  delete global[utils.WPrefix][this.id];\n};\n\nJsonpReceiver.prototype._scriptError = function() {\n  debug('_scriptError');\n  var self = this;\n  if (this.errorTimer) {\n    return;\n  }\n\n  this.errorTimer = setTimeout(function() {\n    if (!self.loadedOkay) {\n      self._abort(new Error('JSONP script loaded abnormally (onerror)'));\n    }\n  }, JsonpReceiver.scriptErrorTimeout);\n};\n\nJsonpReceiver.prototype._createScript = function(url) {\n  debug('_createScript', url);\n  var self = this;\n  var script = this.script = global.document.createElement('script');\n  var script2;  // Opera synchronous load trick.\n\n  script.id = 'a' + random.string(8);\n  script.src = url;\n  script.type = 'text/javascript';\n  script.charset = 'UTF-8';\n  script.onerror = this._scriptError.bind(this);\n  script.onload = function() {\n    debug('onload');\n    self._abort(new Error('JSONP script loaded abnormally (onload)'));\n  };\n\n  // IE9 fires 'error' event after onreadystatechange or before, in random order.\n  // Use loadedOkay to determine if actually errored\n  script.onreadystatechange = function() {\n    debug('onreadystatechange', script.readyState);\n    if (/loaded|closed/.test(script.readyState)) {\n      if (script && script.htmlFor && script.onclick) {\n        self.loadedOkay = true;\n        try {\n          // In IE, actually execute the script.\n          script.onclick();\n        } catch (x) {\n          // intentionally empty\n        }\n      }\n      if (script) {\n        self._abort(new Error('JSONP script loaded abnormally (onreadystatechange)'));\n      }\n    }\n  };\n  // IE: event/htmlFor/onclick trick.\n  // One can't rely on proper order for onreadystatechange. In order to\n  // make sure, set a 'htmlFor' and 'event' properties, so that\n  // script code will be installed as 'onclick' handler for the\n  // script object. Later, onreadystatechange, manually execute this\n  // code. FF and Chrome doesn't work with 'event' and 'htmlFor'\n  // set. For reference see:\n  //   http://jaubourg.net/2010/07/loading-script-as-onclick-handler-of.html\n  // Also, read on that about script ordering:\n  //   http://wiki.whatwg.org/wiki/Dynamic_Script_Execution_Order\n  if (typeof script.async === 'undefined' && global.document.attachEvent) {\n    // According to mozilla docs, in recent browsers script.async defaults\n    // to 'true', so we may use it to detect a good browser:\n    // https://developer.mozilla.org/en/HTML/Element/script\n    if (!browser.isOpera()) {\n      // Naively assume we're in IE\n      try {\n        script.htmlFor = script.id;\n        script.event = 'onclick';\n      } catch (x) {\n        // intentionally empty\n      }\n      script.async = true;\n    } else {\n      // Opera, second sync script hack\n      script2 = this.script2 = global.document.createElement('script');\n      script2.text = \"try{var a = document.getElementById('\" + script.id + \"'); if(a)a.onerror();}catch(x){};\";\n      script.async = script2.async = false;\n    }\n  }\n  if (typeof script.async !== 'undefined') {\n    script.async = true;\n  }\n\n  var head = global.document.getElementsByTagName('head')[0];\n  head.insertBefore(script, head.firstChild);\n  if (script2) {\n    head.insertBefore(script2, head.firstChild);\n  }\n};\n\nmodule.exports = JsonpReceiver;\n"]}