{"version":3,"sources":["server.js"],"names":[],"mappings":"AAAA,IAAI,YAAY,QAAQ,IAAR,CAAhB;IACI,UAAY,QAAQ,oBAAR,CADhB;IAEI,KAAY,QAAQ,IAAR,CAFhB;IAGI,OAAY,QAAQ,MAAR,CAHhB;IAII,QAAY,QAAQ,OAAR,CAJhB;;AAMA,IAAI,OAAU,QAAQ,IAAR,CAAa,CAAb,KAAmB,IAAjC;IACI,SAAU,QAAQ,IAAR,CAAa,CAAb,MAAoB,KADlC;IAEI,UAAU,EAAC,YAAY,CAAC,OAAD,CAAb,EAAwB,MAAM,CAA9B,EAFd;;AAIA,IAAI,iBAAiB,UAAS,OAAT,EAAkB,MAAlB,EAA0B,IAA1B,EAAgC;AACnD,MAAI,KAAK,IAAI,SAAJ,CAAc,OAAd,EAAuB,MAAvB,EAA+B,IAA/B,EAAqC,CAAC,KAAD,EAAQ,MAAR,CAArC,EAAsD,OAAtD,CAAT;AACA,UAAQ,GAAR,CAAY,QAAZ,EAAsB,GAAG,GAAzB,EAA8B,GAAG,OAAjC,EAA0C,GAAG,QAA7C,EAAuD,QAAQ,OAA/D;;AAEA,KAAG,IAAH,CAAQ,EAAR;;AAEA,KAAG,OAAH,GAAa,UAAS,KAAT,EAAgB;AAC3B,YAAQ,GAAR,CAAY,SAAZ,EAAuB,MAAM,IAA7B,EAAmC,MAAM,MAAzC;AACA,SAAK,IAAL;AACD,GAHD;AAID,CAVD;;AAYA,IAAI,iBAAiB,UAAS,OAAT,EAAkB,QAAlB,EAA4B;AAC/C,MAAI,CAAC,UAAU,WAAV,CAAsB,aAAtB,CAAoC,OAApC,CAAL,EACE,OAAO,cAAc,OAAd,EAAuB,QAAvB,CAAP;;AAEF,MAAI,KAAO,IAAI,UAAU,WAAd,CAA0B,OAA1B,EAAmC,QAAnC,CAAX;MACI,OAAO,SAAS,GAAG,WAAZ,EAAyB,EAAzB,KAAgC,CAD3C;;AAGA,UAAQ,GAAR,CAAY,QAAZ,EAAsB,GAAG,GAAzB,EAA8B,GAAG,WAAjC;;AAEA,MAAI,OAAO,YAAY,YAAW;AAChC,YAAQ,CAAR;AACA,OAAG,IAAH,CAAQ,WAAW,IAAnB;AACA,eAAW,YAAW;AACpB,UAAI,EAAJ,EAAQ,GAAG,IAAH,CAAQ,UAAR,EAAoB,EAAC,OAAO,QAAR,EAAkB,IAAI,IAAtB,EAApB;AACT,KAFD,EAEG,IAFH;AAGD,GANU,EAMR,IANQ,CAAX;;AAQA,KAAG,gBAAH,CAAoB,YAAY,eAAhC,EAAiD,IAAjD,CAAsD,EAAtD,EAA0D,EAAC,KAAK,KAAN,EAA1D;;AAEA,KAAG,OAAH,GAAa,YAAW;AACtB,kBAAc,IAAd;AACA,YAAQ,GAAR,CAAY,SAAZ,EAAuB,GAAG,GAA1B;AACA,SAAK,IAAL;AACD,GAJD;AAKD,CAxBD;;AA0BA,IAAI,gBAAgB,UAAS,OAAT,EAAkB,QAAlB,EAA4B;AAC9C,MAAI,OAAO,QAAQ,GAAnB;;AAEA,KAAG,QAAH,CAAY,YAAY,IAAxB,EAA8B,UAAS,GAAT,EAAc,OAAd,EAAuB;AACnD,QAAI,SAAS,MAAM,GAAN,GAAY,GAAzB;AACA,aAAS,SAAT,CAAmB,MAAnB,EAA2B,EAAC,gBAAgB,WAAjB,EAA3B;AACA,aAAS,KAAT,CAAe,WAAW,WAA1B;AACA,aAAS,GAAT;AACD,GALD;AAMD,CATD;;AAWA,IAAI,SAAS,SACA,MAAM,YAAN,CAAmB;AACjB,OAAM,GAAG,YAAH,CAAgB,YAAY,qBAA5B,CADW;AAEjB,QAAM,GAAG,YAAH,CAAgB,YAAY,qBAA5B;AAFW,CAAnB,CADA,GAKA,KAAK,YAAL,EALb;;AAOA,OAAO,EAAP,CAAU,SAAV,EAAqB,cAArB;AACA,OAAO,EAAP,CAAU,SAAV,EAAqB,cAArB;AACA,OAAO,MAAP,CAAc,IAAd","file":"server-compiled.js","sourcesContent":["var WebSocket = require('..'),\n    deflate   = require('permessage-deflate'),\n    fs        = require('fs'),\n    http      = require('http'),\n    https     = require('https');\n\nvar port    = process.argv[2] || 7000,\n    secure  = process.argv[3] === 'tls',\n    options = {extensions: [deflate], ping: 5};\n\nvar upgradeHandler = function(request, socket, head) {\n  var ws = new WebSocket(request, socket, head, ['irc', 'xmpp'], options);\n  console.log('[open]', ws.url, ws.version, ws.protocol, request.headers);\n\n  ws.pipe(ws);\n\n  ws.onclose = function(event) {\n    console.log('[close]', event.code, event.reason);\n    ws = null;\n  };\n};\n\nvar requestHandler = function(request, response) {\n  if (!WebSocket.EventSource.isEventSource(request))\n    return staticHandler(request, response);\n\n  var es   = new WebSocket.EventSource(request, response),\n      time = parseInt(es.lastEventId, 10) || 0;\n\n  console.log('[open]', es.url, es.lastEventId);\n\n  var loop = setInterval(function() {\n    time += 1;\n    es.send('Time: ' + time);\n    setTimeout(function() {\n      if (es) es.send('Update!!', {event: 'update', id: time});\n    }, 1000);\n  }, 2000);\n\n  fs.createReadStream(__dirname + '/haproxy.conf').pipe(es, {end: false});\n\n  es.onclose = function() {\n    clearInterval(loop);\n    console.log('[close]', es.url);\n    es = null;\n  };\n};\n\nvar staticHandler = function(request, response) {\n  var path = request.url;\n\n  fs.readFile(__dirname + path, function(err, content) {\n    var status = err ? 404 : 200;\n    response.writeHead(status, {'Content-Type': 'text/html'});\n    response.write(content || 'Not found');\n    response.end();\n  });\n};\n\nvar server = secure\n           ? https.createServer({\n               key:  fs.readFileSync(__dirname + '/../spec/server.key'),\n               cert: fs.readFileSync(__dirname + '/../spec/server.crt')\n             })\n           : http.createServer();\n\nserver.on('request', requestHandler);\nserver.on('upgrade', upgradeHandler);\nserver.listen(port);\n"]}