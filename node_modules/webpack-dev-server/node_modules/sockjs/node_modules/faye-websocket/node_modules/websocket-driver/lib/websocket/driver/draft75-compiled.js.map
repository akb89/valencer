{"version":3,"sources":["draft75.js"],"names":[],"mappings":"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","file":"draft75-compiled.js","sourcesContent":["'use strict';\n\nvar Base = require('./base'),\n    util = require('util');\n\nvar Draft75 = function(request, url, options) {\n  Base.apply(this, arguments);\n  this._stage  = 0;\n  this.version = 'hixie-75';\n\n  this._headers.set('Upgrade', 'WebSocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('WebSocket-Origin', this._request.headers.origin);\n  this._headers.set('WebSocket-Location', this.url);\n};\nutil.inherits(Draft75, Base);\n\nvar instance = {\n  close: function() {\n    if (this.readyState === 3) return false;\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n\n  parse: function(chunk) {\n    if (this.readyState > 1) return;\n\n    this._reader.put(chunk);\n\n    this._reader.eachByte(function(octet) {\n      var message;\n\n      switch (this._stage) {\n        case -1:\n          this._body.push(octet);\n          this._sendHandshakeBody();\n          break;\n\n        case 0:\n          this._parseLeadingByte(octet);\n          break;\n\n        case 1:\n          this._length = (octet & 0x7F) + 128 * this._length;\n\n          if (this._closing && this._length === 0) {\n            return this.close();\n          }\n          else if ((octet & 0x80) !== 0x80) {\n            if (this._length === 0) {\n              this._stage = 0;\n            }\n            else {\n              this._skipped = 0;\n              this._stage   = 2;\n            }\n          }\n          break;\n\n        case 2:\n          if (octet === 0xFF) {\n            this._stage = 0;\n            message = new Buffer(this._buffer).toString('utf8', 0, this._buffer.length);\n            this.emit('message', new Base.MessageEvent(message));\n          }\n          else {\n            if (this._length) {\n              this._skipped += 1;\n              if (this._skipped === this._length)\n                this._stage = 0;\n            } else {\n              this._buffer.push(octet);\n              if (this._buffer.length > this._maxLength) return this.close();\n            }\n          }\n          break;\n      }\n    }, this);\n  },\n\n  frame: function(buffer) {\n    if (this.readyState === 0) return this._queue([buffer]);\n    if (this.readyState > 1) return false;\n\n    if (typeof buffer !== 'string') buffer = buffer.toString();\n\n    var payload = new Buffer(buffer, 'utf8'),\n        frame   = new Buffer(payload.length + 2);\n\n    frame[0] = 0x00;\n    frame[payload.length + 1] = 0xFF;\n    payload.copy(frame, 1);\n\n    this._write(frame);\n    return true;\n  },\n\n  _handshakeResponse: function() {\n    var start   = 'HTTP/1.1 101 Web Socket Protocol Handshake',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _parseLeadingByte: function(octet) {\n    if ((octet & 0x80) === 0x80) {\n      this._length = 0;\n      this._stage  = 1;\n    } else {\n      delete this._length;\n      delete this._skipped;\n      this._buffer = [];\n      this._stage  = 2;\n    }\n  }\n};\n\nfor (var key in instance)\n  Draft75.prototype[key] = instance[key];\n\nmodule.exports = Draft75;\n"]}