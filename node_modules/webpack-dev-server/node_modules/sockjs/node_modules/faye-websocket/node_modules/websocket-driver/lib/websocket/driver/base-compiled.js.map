{"version":3,"sources":["base.js"],"names":[],"mappings":"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","file":"base-compiled.js","sourcesContent":["'use strict';\n\nvar Emitter = require('events').EventEmitter,\n    util    = require('util'),\n    streams = require('../streams'),\n    Headers = require('./headers'),\n    Reader  = require('./stream_reader');\n\nvar Base = function(request, url, options) {\n  Emitter.call(this);\n  Base.validateOptions(options || {}, ['maxLength', 'masking', 'requireMasking', 'protocols']);\n\n  this._request   = request;\n  this._reader    = new Reader();\n  this._options   = options || {};\n  this._maxLength = this._options.maxLength || this.MAX_LENGTH;\n  this._headers   = new Headers();\n  this.__queue    = [];\n  this.readyState = 0;\n  this.url        = url;\n\n  this.io = new streams.IO(this);\n  this.messages = new streams.Messages(this);\n  this._bindEventListeners();\n};\nutil.inherits(Base, Emitter);\n\nBase.validateOptions = function(options, validKeys) {\n  for (var key in options) {\n    if (validKeys.indexOf(key) < 0)\n      throw new Error('Unrecognized option: ' + key);\n  }\n};\n\nvar instance = {\n  // This is 64MB, small enough for an average VPS to handle without\n  // crashing from process out of memory\n  MAX_LENGTH: 0x3ffffff,\n\n  STATES: ['connecting', 'open', 'closing', 'closed'],\n\n  _bindEventListeners: function() {\n    var self = this;\n\n    // Protocol errors are informational and do not have to be handled\n    this.messages.on('error', function() {});\n\n    this.on('message', function(event) {\n      var messages = self.messages;\n      if (messages.readable) messages.emit('data', event.data);\n    });\n\n    this.on('error', function(error) {\n      var messages = self.messages;\n      if (messages.readable) messages.emit('error', error);\n    });\n\n    this.on('close', function() {\n      var messages = self.messages;\n      if (!messages.readable) return;\n      messages.readable = messages.writable = false;\n      messages.emit('end');\n    });\n  },\n\n  getState: function() {\n    return this.STATES[this.readyState] || null;\n  },\n\n  addExtension: function(extension) {\n    return false;\n  },\n\n  setHeader: function(name, value) {\n    if (this.readyState > 0) return false;\n    this._headers.set(name, value);\n    return true;\n  },\n\n  start: function() {\n    if (this.readyState !== 0) return false;\n    var response = this._handshakeResponse();\n    if (!response) return false;\n    this._write(response);\n    if (this._stage !== -1) this._open();\n    return true;\n  },\n\n  text: function(message) {\n    return this.frame(message);\n  },\n\n  binary: function(message) {\n    return false;\n  },\n\n  ping: function() {\n    return false;\n  },\n\n  pong: function() {\n      return false;\n  },\n\n  close: function(reason, code) {\n    if (this.readyState !== 1) return false;\n    this.readyState = 3;\n    this.emit('close', new Base.CloseEvent(null, null));\n    return true;\n  },\n\n  _open: function() {\n    this.readyState = 1;\n    this.__queue.forEach(function(args) { this.frame.apply(this, args) }, this);\n    this.__queue = [];\n    this.emit('open', new Base.OpenEvent());\n  },\n\n  _queue: function(message) {\n    this.__queue.push(message);\n    return true;\n  },\n\n  _write: function(chunk) {\n    var io = this.io;\n    if (io.readable) io.emit('data', chunk);\n  }\n};\n\nfor (var key in instance)\n  Base.prototype[key] = instance[key];\n\n\nBase.ConnectEvent = function() {};\n\nBase.OpenEvent = function() {};\n\nBase.CloseEvent = function(code, reason) {\n  this.code   = code;\n  this.reason = reason;\n};\n\nBase.MessageEvent = function(data) {\n  this.data = data;\n};\n\nmodule.exports = Base;\n"]}