{"version":3,"sources":["trans-xhr.js"],"names":[],"mappings":"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","file":"trans-xhr-compiled.js","sourcesContent":["// Generated by CoffeeScript 1.9.3\n(function() {\n  var XhrPollingReceiver, XhrStreamingReceiver, transport, utils,\n    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n    hasProp = {}.hasOwnProperty;\n\n  transport = require('./transport');\n\n  utils = require('./utils');\n\n  XhrStreamingReceiver = (function(superClass) {\n    extend(XhrStreamingReceiver, superClass);\n\n    function XhrStreamingReceiver() {\n      return XhrStreamingReceiver.__super__.constructor.apply(this, arguments);\n    }\n\n    XhrStreamingReceiver.prototype.protocol = \"xhr-streaming\";\n\n    XhrStreamingReceiver.prototype.doSendFrame = function(payload) {\n      return XhrStreamingReceiver.__super__.doSendFrame.call(this, payload + '\\n');\n    };\n\n    return XhrStreamingReceiver;\n\n  })(transport.ResponseReceiver);\n\n  XhrPollingReceiver = (function(superClass) {\n    extend(XhrPollingReceiver, superClass);\n\n    function XhrPollingReceiver() {\n      return XhrPollingReceiver.__super__.constructor.apply(this, arguments);\n    }\n\n    XhrPollingReceiver.prototype.protocol = \"xhr-polling\";\n\n    XhrPollingReceiver.prototype.max_response_size = 1;\n\n    return XhrPollingReceiver;\n\n  })(XhrStreamingReceiver);\n\n  exports.app = {\n    xhr_options: function(req, res) {\n      res.statusCode = 204;\n      res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, POST');\n      res.setHeader('Access-Control-Max-Age', res.cache_for);\n      return '';\n    },\n    xhr_send: function(req, res, data) {\n      var d, i, jsonp, len, message, x;\n      if (!data) {\n        throw {\n          status: 500,\n          message: 'Payload expected.'\n        };\n      }\n      try {\n        d = JSON.parse(data);\n      } catch (_error) {\n        x = _error;\n        throw {\n          status: 500,\n          message: 'Broken JSON encoding.'\n        };\n      }\n      if (!d || d.__proto__.constructor !== Array) {\n        throw {\n          status: 500,\n          message: 'Payload expected.'\n        };\n      }\n      jsonp = transport.Session.bySessionId(req.session);\n      if (!jsonp) {\n        throw {\n          status: 404\n        };\n      }\n      for (i = 0, len = d.length; i < len; i++) {\n        message = d[i];\n        jsonp.didMessage(message);\n      }\n      res.setHeader('Content-Type', 'text/plain; charset=UTF-8');\n      res.writeHead(204);\n      res.end();\n      return true;\n    },\n    xhr_cors: function(req, res, content) {\n      var headers, origin;\n      if (!req.headers['origin']) {\n        origin = '*';\n      } else {\n        origin = req.headers['origin'];\n        res.setHeader('Access-Control-Allow-Credentials', 'true');\n      }\n      res.setHeader('Access-Control-Allow-Origin', origin);\n      res.setHeader('Vary', 'Origin');\n      headers = req.headers['access-control-request-headers'];\n      if (headers) {\n        res.setHeader('Access-Control-Allow-Headers', headers);\n      }\n      return content;\n    },\n    xhr_poll: function(req, res, _, next_filter) {\n      res.setHeader('Content-Type', 'application/javascript; charset=UTF-8');\n      res.writeHead(200);\n      transport.register(req, this, new XhrPollingReceiver(req, res, this.options));\n      return true;\n    },\n    xhr_streaming: function(req, res, _, next_filter) {\n      res.setHeader('Content-Type', 'application/javascript; charset=UTF-8');\n      res.writeHead(200);\n      res.write(Array(2049).join('h') + '\\n');\n      transport.register(req, this, new XhrStreamingReceiver(req, res, this.options));\n      return true;\n    }\n  };\n\n}).call(this);\n"]}