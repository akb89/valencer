{"version":3,"sources":["trans-websocket.js"],"names":[],"mappings":"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","file":"trans-websocket-compiled.js","sourcesContent":["// Generated by CoffeeScript 1.9.3\n(function() {\n  var FayeWebsocket, RawWebsocketSessionReceiver, Transport, WebSocketReceiver, transport, utils,\n    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n    hasProp = {}.hasOwnProperty;\n\n  FayeWebsocket = require('faye-websocket');\n\n  utils = require('./utils');\n\n  transport = require('./transport');\n\n  exports.app = {\n    _websocket_check: function(req, connection, head) {\n      if (!FayeWebsocket.isWebSocket(req)) {\n        throw {\n          status: 400,\n          message: 'Not a valid websocket request'\n        };\n      }\n    },\n    sockjs_websocket: function(req, connection, head) {\n      var ws;\n      this._websocket_check(req, connection, head);\n      ws = new FayeWebsocket(req, connection, head, null, this.options.faye_server_options);\n      ws.onopen = (function(_this) {\n        return function() {\n          return transport.registerNoSession(req, _this, new WebSocketReceiver(ws, connection));\n        };\n      })(this);\n      return true;\n    },\n    raw_websocket: function(req, connection, head) {\n      var ver, ws;\n      this._websocket_check(req, connection, head);\n      ver = req.headers['sec-websocket-version'] || '';\n      if (['8', '13'].indexOf(ver) === -1) {\n        throw {\n          status: 400,\n          message: 'Only supported WebSocket protocol is RFC 6455.'\n        };\n      }\n      ws = new FayeWebsocket(req, connection, head, null, this.options.faye_server_options);\n      ws.onopen = (function(_this) {\n        return function() {\n          return new RawWebsocketSessionReceiver(req, connection, _this, ws);\n        };\n      })(this);\n      return true;\n    }\n  };\n\n  WebSocketReceiver = (function(superClass) {\n    extend(WebSocketReceiver, superClass);\n\n    WebSocketReceiver.prototype.protocol = \"websocket\";\n\n    function WebSocketReceiver(ws1, connection1) {\n      var x;\n      this.ws = ws1;\n      this.connection = connection1;\n      try {\n        this.connection.setKeepAlive(true, 5000);\n        this.connection.setNoDelay(true);\n      } catch (_error) {\n        x = _error;\n      }\n      this.ws.addEventListener('message', (function(_this) {\n        return function(m) {\n          return _this.didMessage(m.data);\n        };\n      })(this));\n      this.heartbeat_cb = (function(_this) {\n        return function() {\n          return _this.heartbeat_timeout();\n        };\n      })(this);\n      WebSocketReceiver.__super__.constructor.call(this, this.connection);\n    }\n\n    WebSocketReceiver.prototype.setUp = function() {\n      WebSocketReceiver.__super__.setUp.apply(this, arguments);\n      return this.ws.addEventListener('close', this.thingy_end_cb);\n    };\n\n    WebSocketReceiver.prototype.tearDown = function() {\n      this.ws.removeEventListener('close', this.thingy_end_cb);\n      return WebSocketReceiver.__super__.tearDown.apply(this, arguments);\n    };\n\n    WebSocketReceiver.prototype.didMessage = function(payload) {\n      var i, len, message, msg, results, x;\n      if (this.ws && this.session && payload.length > 0) {\n        try {\n          message = JSON.parse(payload);\n        } catch (_error) {\n          x = _error;\n          return this.didClose(3000, 'Broken framing.');\n        }\n        if (payload[0] === '[') {\n          results = [];\n          for (i = 0, len = message.length; i < len; i++) {\n            msg = message[i];\n            results.push(this.session.didMessage(msg));\n          }\n          return results;\n        } else {\n          return this.session.didMessage(message);\n        }\n      }\n    };\n\n    WebSocketReceiver.prototype.doSendFrame = function(payload) {\n      var x;\n      if (this.ws) {\n        try {\n          this.ws.send(payload);\n          return true;\n        } catch (_error) {\n          x = _error;\n        }\n      }\n      return false;\n    };\n\n    WebSocketReceiver.prototype.didClose = function(status, reason) {\n      var x;\n      if (status == null) {\n        status = 1000;\n      }\n      if (reason == null) {\n        reason = \"Normal closure\";\n      }\n      WebSocketReceiver.__super__.didClose.apply(this, arguments);\n      try {\n        this.ws.close(status, reason, false);\n      } catch (_error) {\n        x = _error;\n      }\n      this.ws = null;\n      return this.connection = null;\n    };\n\n    WebSocketReceiver.prototype.heartbeat = function() {\n      var hto_ref, supportsHeartbeats;\n      supportsHeartbeats = this.ws.ping(null, function() {\n        return clearTimeout(hto_ref);\n      });\n      if (supportsHeartbeats) {\n        return hto_ref = setTimeout(this.heartbeat_cb, 10000);\n      } else {\n        return WebSocketReceiver.__super__.heartbeat.apply(this, arguments);\n      }\n    };\n\n    WebSocketReceiver.prototype.heartbeat_timeout = function() {\n      if (this.session != null) {\n        return this.session.close(3000, 'No response from heartbeat');\n      }\n    };\n\n    return WebSocketReceiver;\n\n  })(transport.GenericReceiver);\n\n  Transport = transport.Transport;\n\n  RawWebsocketSessionReceiver = (function(superClass) {\n    extend(RawWebsocketSessionReceiver, superClass);\n\n    function RawWebsocketSessionReceiver(req, conn, server, ws1) {\n      this.ws = ws1;\n      this.prefix = server.options.prefix;\n      this.readyState = Transport.OPEN;\n      this.recv = {\n        connection: conn,\n        protocol: \"websocket-raw\"\n      };\n      this.connection = new transport.SockJSConnection(this);\n      this.decorateConnection(req);\n      server.emit('connection', this.connection);\n      this._end_cb = (function(_this) {\n        return function() {\n          return _this.didClose();\n        };\n      })(this);\n      this.ws.addEventListener('close', this._end_cb);\n      this._message_cb = (function(_this) {\n        return function(m) {\n          return _this.didMessage(m);\n        };\n      })(this);\n      this.ws.addEventListener('message', this._message_cb);\n    }\n\n    RawWebsocketSessionReceiver.prototype.didMessage = function(m) {\n      if (this.readyState === Transport.OPEN) {\n        this.connection.emit('data', m.data);\n      }\n    };\n\n    RawWebsocketSessionReceiver.prototype.send = function(payload) {\n      if (this.readyState !== Transport.OPEN) {\n        return false;\n      }\n      this.ws.send(payload);\n      return true;\n    };\n\n    RawWebsocketSessionReceiver.prototype.close = function(status, reason) {\n      if (status == null) {\n        status = 1000;\n      }\n      if (reason == null) {\n        reason = \"Normal closure\";\n      }\n      if (this.readyState !== Transport.OPEN) {\n        return false;\n      }\n      this.readyState = Transport.CLOSING;\n      this.ws.close(status, reason, false);\n      return true;\n    };\n\n    RawWebsocketSessionReceiver.prototype.didClose = function() {\n      var x;\n      if (!this.ws) {\n        return;\n      }\n      this.ws.removeEventListener('message', this._message_cb);\n      this.ws.removeEventListener('close', this._end_cb);\n      try {\n        this.ws.close(1000, \"Normal closure\", false);\n      } catch (_error) {\n        x = _error;\n      }\n      this.ws = null;\n      this.readyState = Transport.CLOSED;\n      this.connection.emit('end');\n      this.connection.emit('close');\n      return this.connection = null;\n    };\n\n    return RawWebsocketSessionReceiver;\n\n  })(transport.Session);\n\n}).call(this);\n"]}