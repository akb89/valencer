{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["var httpProxy = module.exports,\n    extend    = require('util')._extend,\n    parse_url = require('url').parse,\n    EE3       = require('eventemitter3'),\n    http      = require('http'),\n    https     = require('https'),\n    web       = require('./passes/web-incoming'),\n    ws        = require('./passes/ws-incoming');\n\nhttpProxy.Server = ProxyServer;\n\n/**\n * Returns a function that creates the loader for\n * either `ws` or `web`'s  passes.\n *\n * Examples:\n *\n *    httpProxy.createRightProxy('ws')\n *    // => [Function]\n *\n * @param {String} Type Either 'ws' or 'web'\n *Â \n * @return {Function} Loader Function that when called returns an iterator for the right passes\n *\n * @api private\n */\n\nfunction createRightProxy(type) {\n\n  return function(options) {\n    return function(req, res /*, [head], [opts] */) {\n      var passes = (type === 'ws') ? this.wsPasses : this.webPasses,\n          args = [].slice.call(arguments),\n          cntr = args.length - 1,\n          head, cbl;\n\n      /* optional args parse begin */\n      if(typeof args[cntr] === 'function') {\n        cbl = args[cntr];\n\n        cntr--;\n      }\n\n      if(\n        !(args[cntr] instanceof Buffer) &&\n        args[cntr] !== res\n      ) {\n        //Copy global options\n        options = extend({}, options);\n        //Overwrite with request options\n        extend(options, args[cntr]);\n\n        cntr--;\n      }\n\n      if(args[cntr] instanceof Buffer) {\n        head = args[cntr];\n      }\n\n      /* optional args parse end */\n\n      ['target', 'forward'].forEach(function(e) {\n        if (typeof options[e] === 'string')\n          options[e] = parse_url(options[e]);\n      });\n\n      if (!options.target && !options.forward) {\n        return this.emit('error', new Error('Must provide a proper URL as target'));\n      }\n\n      for(var i=0; i < passes.length; i++) {\n        /**\n         * Call of passes functions\n         * pass(req, res, options, head)\n         *\n         * In WebSockets case the `res` variable\n         * refer to the connection socket\n         * pass(req, socket, options, head)\n         */\n        if(passes[i](req, res, options, head, this, cbl)) { // passes can return a truthy value to halt the loop\n          break;\n        }\n      }\n    };\n  };\n}\nhttpProxy.createRightProxy = createRightProxy;\n\nfunction ProxyServer(options) {\n  EE3.call(this);\n\n  options = options || {};\n  options.prependPath = options.prependPath === false ? false : true;\n\n  this.web = this.proxyRequest           = createRightProxy('web')(options);\n  this.ws  = this.proxyWebsocketRequest  = createRightProxy('ws')(options);\n  this.options = options;\n\n  this.webPasses = Object.keys(web).map(function(pass) {\n    return web[pass];\n  });\n\n  this.wsPasses = Object.keys(ws).map(function(pass) {\n    return ws[pass];\n  });\n\n  this.on('error', this.onError, this);\n\n}\n\nrequire('util').inherits(ProxyServer, EE3);\n\nProxyServer.prototype.onError = function (err) {\n  //\n  // Remark: Replicate node core behavior using EE3\n  // so we force people to handle their own errors\n  //\n  if(this.listeners('error').length === 1) {\n    throw err;\n  }\n};\n\nProxyServer.prototype.listen = function(port, hostname) {\n  var self    = this,\n      closure = function(req, res) { self.web(req, res); };\n\n  this._server  = this.options.ssl ?\n    https.createServer(this.options.ssl, closure) :\n    http.createServer(closure);\n\n  if(this.options.ws) {\n    this._server.on('upgrade', function(req, socket, head) { self.ws(req, socket, head); });\n  }\n\n  this._server.listen(port, hostname);\n\n  return this;\n};\n\nProxyServer.prototype.close = function(callback) {\n  var self = this;\n  if (this._server) {\n    this._server.close(done);\n  }\n\n  // Wrap callback to nullify server after all open connections are closed.\n  function done() {\n    self._server = null;\n    if (callback) {\n      callback.apply(null, arguments);\n    }\n  };\n};\n\nProxyServer.prototype.before = function(type, passName, callback) {\n  if (type !== 'ws' && type !== 'web') {\n    throw new Error('type must be `web` or `ws`');\n  }\n  var passes = (type === 'ws') ? this.wsPasses : this.webPasses,\n      i = false;\n\n  passes.forEach(function(v, idx) {\n    if(v.name === passName) i = idx;\n  })\n\n  if(i === false) throw new Error('No such pass');\n\n  passes.splice(i, 0, callback);\n};\nProxyServer.prototype.after = function(type, passName, callback) {\n  if (type !== 'ws' && type !== 'web') {\n    throw new Error('type must be `web` or `ws`');\n  }\n  var passes = (type === 'ws') ? this.wsPasses : this.webPasses,\n      i = false;\n\n  passes.forEach(function(v, idx) {\n    if(v.name === passName) i = idx;\n  })\n\n  if(i === false) throw new Error('No such pass');\n\n  passes.splice(i++, 0, callback);\n};\n"]}