{"version":3,"sources":["using.js"],"names":[],"mappings":"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","file":"using-compiled.js","sourcesContent":["\"use strict\";\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise,\n    createContext, INTERNAL, debug) {\n    var util = require(\"./util\");\n    var TypeError = require(\"./errors\").TypeError;\n    var inherits = require(\"./util\").inherits;\n    var errorObj = util.errorObj;\n    var tryCatch = util.tryCatch;\n    var NULL = {};\n\n    function thrower(e) {\n        setTimeout(function(){throw e;}, 0);\n    }\n\n    function castPreservingDisposable(thenable) {\n        var maybePromise = tryConvertToPromise(thenable);\n        if (maybePromise !== thenable &&\n            typeof thenable._isDisposable === \"function\" &&\n            typeof thenable._getDisposer === \"function\" &&\n            thenable._isDisposable()) {\n            maybePromise._setDisposable(thenable._getDisposer());\n        }\n        return maybePromise;\n    }\n    function dispose(resources, inspection) {\n        var i = 0;\n        var len = resources.length;\n        var ret = new Promise(INTERNAL);\n        function iterator() {\n            if (i >= len) return ret._fulfill();\n            var maybePromise = castPreservingDisposable(resources[i++]);\n            if (maybePromise instanceof Promise &&\n                maybePromise._isDisposable()) {\n                try {\n                    maybePromise = tryConvertToPromise(\n                        maybePromise._getDisposer().tryDispose(inspection),\n                        resources.promise);\n                } catch (e) {\n                    return thrower(e);\n                }\n                if (maybePromise instanceof Promise) {\n                    return maybePromise._then(iterator, thrower,\n                                              null, null, null);\n                }\n            }\n            iterator();\n        }\n        iterator();\n        return ret;\n    }\n\n    function Disposer(data, promise, context) {\n        this._data = data;\n        this._promise = promise;\n        this._context = context;\n    }\n\n    Disposer.prototype.data = function () {\n        return this._data;\n    };\n\n    Disposer.prototype.promise = function () {\n        return this._promise;\n    };\n\n    Disposer.prototype.resource = function () {\n        if (this.promise().isFulfilled()) {\n            return this.promise().value();\n        }\n        return NULL;\n    };\n\n    Disposer.prototype.tryDispose = function(inspection) {\n        var resource = this.resource();\n        var context = this._context;\n        if (context !== undefined) context._pushContext();\n        var ret = resource !== NULL\n            ? this.doDispose(resource, inspection) : null;\n        if (context !== undefined) context._popContext();\n        this._promise._unsetDisposable();\n        this._data = null;\n        return ret;\n    };\n\n    Disposer.isDisposer = function (d) {\n        return (d != null &&\n                typeof d.resource === \"function\" &&\n                typeof d.tryDispose === \"function\");\n    };\n\n    function FunctionDisposer(fn, promise, context) {\n        this.constructor$(fn, promise, context);\n    }\n    inherits(FunctionDisposer, Disposer);\n\n    FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n        var fn = this.data();\n        return fn.call(resource, resource, inspection);\n    };\n\n    function maybeUnwrapDisposer(value) {\n        if (Disposer.isDisposer(value)) {\n            this.resources[this.index]._setDisposable(value);\n            return value.promise();\n        }\n        return value;\n    }\n\n    function ResourceList(length) {\n        this.length = length;\n        this.promise = null;\n        this[length-1] = null;\n    }\n\n    ResourceList.prototype._resultCancelled = function() {\n        var len = this.length;\n        for (var i = 0; i < len; ++i) {\n            var item = this[i];\n            if (item instanceof Promise) {\n                item.cancel();\n            }\n        }\n    };\n\n    Promise.using = function () {\n        var len = arguments.length;\n        if (len < 2) return apiRejection(\n                        \"you must pass at least 2 arguments to Promise.using\");\n        var fn = arguments[len - 1];\n        if (typeof fn !== \"function\") {\n            return apiRejection(\"expecting a function but got \" + util.classString(fn));\n        }\n        var input;\n        var spreadArgs = true;\n        if (len === 2 && Array.isArray(arguments[0])) {\n            input = arguments[0];\n            len = input.length;\n            spreadArgs = false;\n        } else {\n            input = arguments;\n            len--;\n        }\n        var resources = new ResourceList(len);\n        for (var i = 0; i < len; ++i) {\n            var resource = input[i];\n            if (Disposer.isDisposer(resource)) {\n                var disposer = resource;\n                resource = resource.promise();\n                resource._setDisposable(disposer);\n            } else {\n                var maybePromise = tryConvertToPromise(resource);\n                if (maybePromise instanceof Promise) {\n                    resource =\n                        maybePromise._then(maybeUnwrapDisposer, null, null, {\n                            resources: resources,\n                            index: i\n                    }, undefined);\n                }\n            }\n            resources[i] = resource;\n        }\n\n        var reflectedResources = new Array(resources.length);\n        for (var i = 0; i < reflectedResources.length; ++i) {\n            reflectedResources[i] = Promise.resolve(resources[i]).reflect();\n        }\n\n        var resultPromise = Promise.all(reflectedResources)\n            .then(function(inspections) {\n                for (var i = 0; i < inspections.length; ++i) {\n                    var inspection = inspections[i];\n                    if (inspection.isRejected()) {\n                        errorObj.e = inspection.error();\n                        return errorObj;\n                    } else if (!inspection.isFulfilled()) {\n                        resultPromise.cancel();\n                        return;\n                    }\n                    inspections[i] = inspection.value();\n                }\n                promise._pushContext();\n\n                fn = tryCatch(fn);\n                var ret = spreadArgs\n                    ? fn.apply(undefined, inspections) : fn(inspections);\n                var promiseCreated = promise._popContext();\n                debug.checkForgottenReturns(\n                    ret, promiseCreated, \"Promise.using\", promise);\n                return ret;\n            });\n\n        var promise = resultPromise.lastly(function() {\n            var inspection = new Promise.PromiseInspection(resultPromise);\n            return dispose(resources, inspection);\n        });\n        resources.promise = promise;\n        promise._setOnCancel(resources);\n        return promise;\n    };\n\n    Promise.prototype._setDisposable = function (disposer) {\n        this._bitField = this._bitField | 131072;\n        this._disposer = disposer;\n    };\n\n    Promise.prototype._isDisposable = function () {\n        return (this._bitField & 131072) > 0;\n    };\n\n    Promise.prototype._getDisposer = function () {\n        return this._disposer;\n    };\n\n    Promise.prototype._unsetDisposable = function () {\n        this._bitField = this._bitField & (~131072);\n        this._disposer = undefined;\n    };\n\n    Promise.prototype.disposer = function (fn) {\n        if (typeof fn === \"function\") {\n            return new FunctionDisposer(fn, this, createContext());\n        }\n        throw new TypeError();\n    };\n\n};\n"]}