{"version":3,"sources":["multipart.js"],"names":[],"mappings":"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","file":"multipart-compiled.js","sourcesContent":["'use strict'\n\nvar uuid = require('node-uuid')\n  , CombinedStream = require('combined-stream')\n  , isstream = require('isstream')\n\n\nfunction Multipart (request) {\n  this.request = request\n  this.boundary = uuid()\n  this.chunked = false\n  this.body = null\n}\n\nMultipart.prototype.isChunked = function (options) {\n  var self = this\n    , chunked = false\n    , parts = options.data || options\n\n  if (!parts.forEach) {\n    self.request.emit('error', new Error('Argument error, options.multipart.'))\n  }\n\n  if (options.chunked !== undefined) {\n    chunked = options.chunked\n  }\n\n  if (self.request.getHeader('transfer-encoding') === 'chunked') {\n    chunked = true\n  }\n\n  if (!chunked) {\n    parts.forEach(function (part) {\n      if (typeof part.body === 'undefined') {\n        self.request.emit('error', new Error('Body attribute missing in multipart.'))\n      }\n      if (isstream(part.body)) {\n        chunked = true\n      }\n    })\n  }\n\n  return chunked\n}\n\nMultipart.prototype.setHeaders = function (chunked) {\n  var self = this\n\n  if (chunked && !self.request.hasHeader('transfer-encoding')) {\n    self.request.setHeader('transfer-encoding', 'chunked')\n  }\n\n  var header = self.request.getHeader('content-type')\n\n  if (!header || header.indexOf('multipart') === -1) {\n    self.request.setHeader('content-type', 'multipart/related; boundary=' + self.boundary)\n  } else {\n    if (header.indexOf('boundary') !== -1) {\n      self.boundary = header.replace(/.*boundary=([^\\s;]+).*/, '$1')\n    } else {\n      self.request.setHeader('content-type', header + '; boundary=' + self.boundary)\n    }\n  }\n}\n\nMultipart.prototype.build = function (parts, chunked) {\n  var self = this\n  var body = chunked ? new CombinedStream() : []\n\n  function add (part) {\n    if (typeof part === 'number') {\n      part = part.toString()\n    }\n    return chunked ? body.append(part) : body.push(new Buffer(part))\n  }\n\n  if (self.request.preambleCRLF) {\n    add('\\r\\n')\n  }\n\n  parts.forEach(function (part) {\n    var preamble = '--' + self.boundary + '\\r\\n'\n    Object.keys(part).forEach(function (key) {\n      if (key === 'body') { return }\n      preamble += key + ': ' + part[key] + '\\r\\n'\n    })\n    preamble += '\\r\\n'\n    add(preamble)\n    add(part.body)\n    add('\\r\\n')\n  })\n  add('--' + self.boundary + '--')\n\n  if (self.request.postambleCRLF) {\n    add('\\r\\n')\n  }\n\n  return body\n}\n\nMultipart.prototype.onRequest = function (options) {\n  var self = this\n\n  var chunked = self.isChunked(options)\n    , parts = options.data || options\n\n  self.setHeaders(chunked)\n  self.chunked = chunked\n  self.body = self.build(parts, chunked)\n}\n\nexports.Multipart = Multipart\n"]}